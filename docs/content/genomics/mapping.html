<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.54">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>14&nbsp; Alignment to reference genome – Introduction to Bioinformatics for Malaria Molecular Surveillance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../content/genomics/variant-calling.html" rel="next">
<link href="../../content/genomics/qc.html" rel="prev">
<link href="../../content/assets/ITM-symbol_col_rgb.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/genomics/setup.html">Processing genomic data</a></li><li class="breadcrumb-item"><a href="../../content/genomics/mapping.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Alignment to reference genome</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="https://research.itg.be/en/organisations/malariology" class="sidebar-logo-link">
      <img src="../../content/assets/ITM-logo_col_rgb.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">Introduction to Bioinformatics for Malaria Molecular Surveillance</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/pmoris/FiMAB-bioinformatics" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to the Unix shell</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/1-unix-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">What is a CLI?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/2-unix-setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Setting up your own Unix shell</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/3-unix-enter-the-shell.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Using the shell</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/4-unix-navigation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Navigating the Unix file system</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/5-unix-files-and-dirs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with files and directories</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/6-unix-more-commands.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">More advanced commands</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/7-unix-redirection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Streams, redirection and piping</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/8-unix-variables-loops-scripts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Variables, loops and scripts</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Introduction to R</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/r/r-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">R introduction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/r/r-resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Other R resources</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Processing genomic data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Setup and preparations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/pipeline-overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Pipeline overview</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/tools-and-formats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Bioinformatics tools and file formats</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/qc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Quality control and trimming</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/mapping.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Alignment to reference genome</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/genomics/variant-calling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Variant calling</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../content/unix/appendix-unix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Various Unix topics</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#where-to-find-your-reference-genomes---bwa-mem" id="toc-where-to-find-your-reference-genomes---bwa-mem" class="nav-link active" data-scroll-target="#where-to-find-your-reference-genomes---bwa-mem"><span class="header-section-number">14.1</span> Where to find your reference genomes - <code>bwa mem</code></a></li>
  <li><a href="#indexing-a-reference-genome" id="toc-indexing-a-reference-genome" class="nav-link" data-scroll-target="#indexing-a-reference-genome"><span class="header-section-number">14.2</span> Indexing a reference genome</a></li>
  <li><a href="#sec-alignment" id="toc-sec-alignment" class="nav-link" data-scroll-target="#sec-alignment"><span class="header-section-number">14.3</span> Alignment to the reference genome</a></li>
  <li><a href="#sec-samtools" id="toc-sec-samtools" class="nav-link" data-scroll-target="#sec-samtools"><span class="header-section-number">14.4</span> SAM and BAM files</a></li>
  <li><a href="#coordinate-sorting-alignment-files" id="toc-coordinate-sorting-alignment-files" class="nav-link" data-scroll-target="#coordinate-sorting-alignment-files"><span class="header-section-number">14.5</span> Coordinate sorting alignment files</a></li>
  <li><a href="#sec-samtools-flagstat" id="toc-sec-samtools-flagstat" class="nav-link" data-scroll-target="#sec-samtools-flagstat"><span class="header-section-number">14.6</span> Inspecting BAM files</a>
  <ul>
  <li><a href="#sec-samtools-index" id="toc-sec-samtools-index" class="nav-link" data-scroll-target="#sec-samtools-index"><span class="header-section-number">14.6.1</span> More indices</a></li>
  </ul></li>
  <li><a href="#sec-picard-duplicates" id="toc-sec-picard-duplicates" class="nav-link" data-scroll-target="#sec-picard-duplicates"><span class="header-section-number">14.7</span> Mark PCR duplicates - <code>picard MarkDuplicates</code></a></li>
  <li><a href="#sec-picard-metrics" id="toc-sec-picard-metrics" class="nav-link" data-scroll-target="#sec-picard-metrics"><span class="header-section-number">14.8</span> Alignment statistics</a></li>
  <li><a href="#sec-alignment-visualisation" id="toc-sec-alignment-visualisation" class="nav-link" data-scroll-target="#sec-alignment-visualisation"><span class="header-section-number">14.9</span> Alignment visualisation</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../content/genomics/setup.html">Processing genomic data</a></li><li class="breadcrumb-item"><a href="../../content/genomics/mapping.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Alignment to reference genome</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Alignment to reference genome</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The next step of our pipeline tries to align the filtered and trimmed reads to the reference genome of the organism we’re studying. It starts from the processed <code>FASTQ</code> files and produces <code>SAM</code> and <code>BAM</code> files, which contain the mapped reads. We encountered these file formats before in <a href="../unix/6-unix-more-commands.html#sec-sam-format" class="quarto-xref"><span>Section 6.2.1</span></a> and <a href="../unix/6-unix-more-commands.html#sec-bam-format" class="quarto-xref"><span>Section 6.4.1</span></a>, but we will go a bit more in-depth now. Two other important aspects in this part of the pipeline are indexing the reference genome and filtering out PCR duplicates from our alignment.</p>
<p><a href="../assets/pipeline-mapping.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="../assets/pipeline-mapping.svg" class="no-lightbox img-fluid"></a></p>
<div id="tip-reproducibility" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip&nbsp;14.1: Reproducibility and organized projects
</div>
</div>
<div class="callout-body-container callout-body">
<p>To make your analyses more reproducible, and to be able to figure out what you did in the (distant) future, it is important to use meaningful file names and to organise all of your data, scripts and accompanying files (like metadata and readme files, see <a href="#tip-reproducibility-2" class="quarto-xref">Tip&nbsp;<span>14.2</span></a>). During these hands-on sessions, try to already think about naming conventions and a clear hierarchy of your files and directories.</p>
<p>We will write separate scripts for each of the different parts of the pipeline, but at the very end, we can try to merge them into just a handful scripts for each of the major conceptual steps, optionally accompanied by a master script to govern them all.</p>
<p>As a last tip, try to be aware of the types of paths that you use when writing your scripts: absolute or relative ones (<a href="../unix/4-unix-navigation.html#sec-linux-paths" class="quarto-xref"><span>Section 4.1</span></a>).</p>
<p>Relative paths are more portable than absolute ones (which will not work on a different workstation with different file paths), but they can be more prone to errors. Indeed, the relative path is defined based on where call the script from, rather than the location of the script itself, so be mindful of this.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Whichever type you use, we recommend to define all important files and folders at the top of your scripts as variables. This makes it easier to change them at a later time.</p>
<p>You can already compare the basic and extended versions of some of the example scripts stored in the <code>./training/scripts</code> directory to see how you can extend a simple script to make it more robust and reusable (and hopefully clear).</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;An alternative is to make use of relative paths, but in that case the script still needs to be called from a fixed location in your project folders (or you need to make use of <a href="https://stackoverflow.com/a/246128">this strategy</a>). For even more complex scripts, you might want to look into providing paths as an argument, or to make use of configuration or samplesheets (as is done by more complex workflow manager tools).</p></div></div><section id="where-to-find-your-reference-genomes---bwa-mem" class="level2 page-columns page-full" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="where-to-find-your-reference-genomes---bwa-mem"><span class="header-section-number">14.1</span> Where to find your reference genomes - <code>bwa mem</code></h2>
<p>We already downloaded a reference genome from <a href="https://plasmodb.org/plasmo/app/downloads">PlasmoDB</a> in <a href="../unix/6-unix-more-commands.html#sec-plasmodb" class="quarto-xref"><span>Section 6.5</span></a> (where we introduced the <code>wget</code> command). These reference genomes allow us to compare the samples we have collected with a representative reference type_of the organism that we’re studying<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. For some organisms, multiple reference genomes exist (e.g., because the organism exhibits a lot of genetic variability between different geographic locations), and these references also receive updates from time to time, as the assemblies of complex regions improves (e.g., gaps spanned, repetitive regions mapped, or in the case of <em>Plasmodium</em>, the polymorphic subtelomeric regions).</p>
<div class="no-row-height column-margin column-container"><div id="fn2"><p><sup>2</sup>&nbsp;In practice, reference genomes rarely contain the genetic material of a single individual. Instead, they tend to be a mosaic of DNA sequences from different sources. See <a href="https://en.wikipedia.org/wiki/Reference_genome">https://en.wikipedia.org/wiki/Reference_genome</a>.</p></div></div><div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Download the most recent releases of the <em>P. falciparum</em> 3D7 and the <em>P. vivax</em> P01 reference genomes and store them in <code>./data/references</code> in clearly labelled subdirectories.</li>
<li>Try to inspect the file using <code>head</code> and <code>less</code>.</li>
</ul>
</div>
</div>
</section>
<section id="indexing-a-reference-genome" class="level2 page-columns page-full" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="indexing-a-reference-genome"><span class="header-section-number">14.2</span> Indexing a reference genome</h2>
<p>Before we can map our reads to a reference genome, we need to create an index to allow our mapper to more efficiently search through the (usually rather large) FASTA file<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. You can think of it like the index or table of contents of a book (if that particular book contained about <em>23 million characters</em> in the case of <em>Plasmodium falciparum</em>, or <em>3.1 billion characters</em> for the human reference genome).</p>
<div class="no-row-height column-margin column-container"><div id="fn3"><p><sup>3</sup>&nbsp;For a refresher on the FASTA file format, check out <a href="../unix/5-unix-files-and-dirs.html#sec-fasta" class="quarto-xref"><span>Section 5.1.2.1</span></a>.</p></div></div><p>The indexing step itself is usually performed by the same tool as the one that does the actual alignment. The index <strong>only needs to be created once</strong>, and then it can be re-used when mapping each of our FASTQ files. In this course, we will be using <code>bwa</code> - the <a href="https://github.com/lh3/bwa">Burrows-Wheeler Aligner</a>.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Use the <code>bwa index &lt;reference.fasta&gt;</code> command to create an index for both reference genomes.</li>
<li>Which files were created by the indexing step?</li>
</ul>
</div>
</div>
<div id="tip-reproducibility-2" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip&nbsp;14.2: Collaboration and reproducibility
</div>
</div>
<div class="callout-body-container callout-body">
<p>We’d like to mention two important related aspects of (computational) scientific workflows here: collaboration and reproducibility.</p>
<ol type="1">
<li><p>Reference genomes and their indices take up a lot of space. In the case of larger genomes, like the human one, it also takes considerable time to produce the index. Fortunately, these files can be re-used for any future analysis - not just by you, but by others as well. That is why we recommend to store these references and their indices in a shared location on your lab’s workstation, so that they become accessible to others who might benefit from them.</p></li>
<li><p>To ease collaboration with others, but also with your future self, it is a good idea to keep track of the various steps you’ve performed in your analysis, just like you would do in a lab notebook. Of course the code and scripts that you write should be clearly named (and ideally, elaborated with clear comments), but it also fruitful to note down more nitty-gritty details on how you managed to fix a particular issue or why a specific option was chosen. In the case of reference genomes, we recommend to create a <code>README.md</code> file<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> to store alongside your reference genomes, which clearly describes where you obtained them, the version/build/release, and perhaps even a code snippet to re-download and <a href="https://genomicsaotearoa.github.io/shell-for-bioinformatics/2_download_data/">checksum</a> them.</p></li>
</ol>
<p>As a <strong>bonus exercise</strong>, try to create such a readme file.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn4"><p><sup>4</sup>&nbsp;<code>.md</code> stands for markdown, which is a popular <a href="https://www.markdownguide.org/getting-started/">plain-text markup language</a> used for these kinds of tasks. You will often see people used markdown or <code>.txt</code> files to add metadata to collections of files in databases and analysis scripts or workflows on places like <a href="https://www.github.com">GitHub</a>.</p></div></div></section>
<section id="sec-alignment" class="level2 page-columns page-full" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="sec-alignment"><span class="header-section-number">14.3</span> Alignment to the reference genome</h2>
<p>During mapping, the aligner tries to find a potential alignment site for each individual read (or query) in the reference genome. After aligning all the reads, we can start looking for variation in our samples compared to the reference genome and each other.</p>
<p>There exist many different tools and algorithms for sequence alignment, each with their own strengths and weaknesses. A few examples of popular ones for DNA sequencing are <a href="https://bio-bwa.sourceforge.net/">BWA</a>, <a href="https://bowtie-bio.sourceforge.net/bowtie2/index.shtml">bowtie2</a> and <a href="https://github.com/lh3/minimap2">minimap2</a>. The differences between these tools mostly lies in speed vs sensitivity, but also preferred application; i.e.&nbsp;long versus short reads<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn5"><p><sup>5</sup>&nbsp;You can read the author of BWA and minimap2 thoughts: <a href="https://lh3.github.io/2018/04/02/minimap2-and-the-future-of-bwa">https://lh3.github.io/2018/04/02/minimap2-and-the-future-of-bwa</a></p></div></div><p>Note that there is also an entirely different class of aligners that were developed for RNA-sequencing; these need to be <em>“splice-aware”</em> to handle RNA reads without introns (e.g., STAR), and some of them also make use of some clever tricks for faster quantifications - so-called <em>pseudo-aligners</em> (e.g, Kallisto and Salmon).</p>
<p>We will use BWA as our mapping tool of choice, <a href="https://www.malariagen.net/wp-content/uploads/2023/11/Pf7-Details-of-bioinformatics-methods.pdf">as is customary</a> in the field of malaria genomics <span class="citation" data-cites="malariagen_pf7_2023">(<a href="../references.html#ref-malariagen_pf7_2023" role="doc-biblioref">MalariaGEN et al. 2023</a>)</span>. BWA actually comes with three different flavours of aligners, but the most recent and popular one is <code>bwa mem</code><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="no-row-height column-margin column-container"><div id="fn6"><p><sup>6</sup>&nbsp;A <a href="https://github.com/bwa-mem2/bwa-mem2">second version of <code>bwa mem</code></a> has also been released, but while it is faster, it is more suited for running on high-performance compute clusters or in the cloud, due to the higher memory requirements.</p></div></div><hr>
<p><a href="#fig-mapping" class="quarto-xref">Figure&nbsp;<span>14.1</span></a> illustrates the mapping process <span class="citation" data-cites="Hiltemann_2023 sequence-analysis-mapping">(<a href="../references.html#ref-Hiltemann_2023" role="doc-biblioref">Hiltemann et al. 2023</a>; <a href="../references.html#ref-sequence-analysis-mapping" role="doc-biblioref">Wolff, Batut, and Rasche</a>)</span>. Each individual read is matched against the reference. You can see that read 1 has a few mismatches in its alignment, which eventually might turn out to be single nucleotide polymorphisms (<em>SNP</em>). Similarly, for read 2 only the middle part aligns well; <code>bwa mem</code> performs a local alignment and can clip the ends of the read. The third read shows an example of an insertion and a deletion (<em>indel</em>); the read is longer in one area (<code>GCCA</code>), but shorter in another (<code>AC(A)TA</code>).</p>
<div id="fig-mapping" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mapping-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="../assets/mapping.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;14.1: Mapping reads to a reference. [Source:@Hiltemann_2023; @sequence-analysis-mapping]"><img src="../assets/mapping.png" class="img-fluid figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-mapping-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14.1: Mapping reads to a reference. <span class="citation" data-cites="Hiltemann_2023 sequence-analysis-mapping">(Source: <a href="../references.html#ref-Hiltemann_2023" role="doc-biblioref">Hiltemann et al. 2023</a>; <a href="../references.html#ref-sequence-analysis-mapping" role="doc-biblioref">Wolff, Batut, and Rasche</a>)</span>
</figcaption>
</figure>
</div>
<p>As we discussed in <a href="qc.html#tip-paired-end" class="quarto-xref">Tip&nbsp;<span>13.1</span></a>, when we are working with <em>paired-end sequencing data</em>, there is additional information available for the aligner to work with. The expected distance between forward and reverse reads that can help to span repetitive regions. For this to work, paired reads are always mapped together, which is why they also need to be provided to the mapping tool as a pair; that is why we tend to give them similar file names (<code>*R1.fastq</code>/<code>*_R2.fastq</code>), and the paired reads appear in the same order in each file. The final alignment report usually provides dedicated output on paired reads, letting us know of cases where one of the reads fails to map (<em>unmapped mate</em>) or the pair is not in the expected orientation (i.e., not pointing towards each other, see <a href="#tip-read-orientation" class="quarto-xref">Tip&nbsp;<span>14.3</span></a>) / too far apart (not <em>properly paired</em>) , because this is not something that you’d expect in normal circumstances, since they <em>should</em> be derived from the same fragment of DNA.</p>
<div id="tip-read-orientation" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip&nbsp;14.3: Orientation of forward and reverse reads during mapping
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>The following is based on the excellent write-up on <a href="https://www.cureffi.org/2012/12/19/forward-and-reverse-reads-in-paired-end-sequencing/">https://www.cureffi.org/2012/12/19/forward-and-reverse-reads-in-paired-end-sequencing/</a></em> and <em><a href="https://seekdeep.brown.edu/illumina_paired_info.html">https://seekdeep.brown.edu/illumina_paired_info.html</a></em>.</p>
<p>Recall that during sequencing-by-synthesis, the new strand is always synthesized in the 5’-3’ direction (since <a href="http://en.wikipedia.org/wiki/DNA_polymerase">DNA polymerase</a> walks along the template strand in the 3’-5’ direction). The newly synthesized strand is what is being read out during the sequencing process, so this is what eventually ends up in our FASTQ files.</p>
<p>For paired-end sequencing, this means eventually results in the reverse read (read 2) being in the opposite orientation of the first read (read 1); it is read from the complementary strand compared to read 1 and also in the opposite direction. Consequently, the mapping software will need to take the <em>reverse complement</em> of read 2, to put it in the same orientation as read 1, before aligning it to the reference genome (or equivalently, try to map it to the other strand of the reference genome).</p>
<p><a href="../assets/paired-end.svg" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="../assets/paired-end.svg" class="img-fluid"></a></p>
<blockquote class="blockquote">
<p>For Illumina paired-end sequencing, the double-stranded library fragments (= insert + adapter sequences (= anchor + read primer + index + index primer), see <a href="qc.html#fig-library-fragment-illumina" class="quarto-xref">Figure&nbsp;<span>13.3</span></a>) are first attached to the flow cell, but then the complementary strands (5’-3’ oriented towards the flow cell) are removed. The template strand (3’-5’ oriented towards the flow cell) is then used to synthesize and sequence the forward read in the 5’-3’ direction, starting from read primer 1 (adjacent to the insert). Next, index 1 (I7) is sequenced in a separate reaction (using the i7 index primer). For the reverse reads, the template strand is first used to regenerate its complementary strand (which gets attached to the flow cell), and is then removed. Lastly, the read 2 primer is used to sequence the reverse read, again in the 5’-3’ direction.</p>
<p>If you need a refresher, you can always jump back to one of the resources on the Illumina sequencing chemistry in <a href="qc.html" class="quarto-xref"><span>Chapter 13</span></a> like <span class="citation" data-cites="ClevaLab_2022_blog">ClevaLab (<a href="../references.html#ref-ClevaLab_2022_blog" role="doc-biblioref">2022</a>)</span>.</p>
</blockquote>
</div>
</div>
<p>When we call <code>bwa mem</code> without any additional arguments, we get an overview of how to use it:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Usage:</span> bwa mem <span class="pp">[</span><span class="ss">options</span><span class="pp">]</span> <span class="op">&lt;</span>reference-genome<span class="op">&gt;</span> <span class="op">&lt;</span>R1.fastq<span class="op">&gt;</span> <span class="pp">[</span><span class="ss">R2.fastq</span><span class="pp">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you can see, the second read pair file is <code>[optional]</code>, but when dealing with paired-end read data the two files need to be supplied at the same time. To do this programmatically, it is again important to use concepts like <em>looping over pairs of FASTQ files</em> to do this efficiently (see <a href="qc.html#tip-paired-fastq-loop" class="quarto-xref">Tip&nbsp;<span>13.2</span></a>).</p>
<p>By default, <code>bwa</code> will output its results straight into the terminal’s standard out (see <a href="../unix/7-unix-redirection.html#sec-unix-streams" class="quarto-xref"><span>Section 7.1</span></a>). This is very useful once we start chaining different tools together, but for your first attempts you should provide the <code>-o &lt;output_file&gt;</code> flag to write everything to a file instead.</p>
<p><code>bwa mem</code> provides <em>many</em> different options, but we recommend the following ones:</p>
<ul>
<li><code>-t &lt;int&gt;</code>: the number of threads to use. See <a href="#tip-parallel" class="quarto-xref">Tip&nbsp;<span>14.4</span></a>.</li>
<li><code>-R "@RG\tID:L001\tPL:ILLUMINA\tSM:${sample}"</code>: defines <em>read groups</em>, which are tags to identify which reads belong together across flowcells/lanes/library preparations<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. <code>${sample}</code> is a variable containing the sample name of the current read (pair) in a for loop.</li>
<li><code>-Y</code>: use <a href="https://medium.com/@lwy730050619/soft-clipping-vs-hard-clipping-in-read-alignment-bd0c96f47426">soft clipping</a> for <a href="https://www.biostars.org/p/308853/">supplementary alignments</a>.</li>
<li><code>K 100000000</code>: makes results more <a href="https://github.com/CCDG/Pipeline-Standardization/issues/2">deterministic</a>. </li>
</ul>
<div class="no-row-height column-margin column-container"><div id="fn7"><p><sup>7</sup>&nbsp;Reads groups are a <a href="https://www.biostars.org/p/43897/">confusing subject</a>, and <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890671-Read-groups">a very deep</a> one as well. In a nutshell, read groups are used to inform downstream tools about which reads were sequenced together in the same flowcell/lane (to differentiate between and account for technical variability between runs, and not just samples) and which reads need to be grouped because they are derived from the same sample (but stored in separate files). Fortunately, they are only required by a few downstream GATK tools, but leaving them out <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035532352-Errors-about-read-group-RG-information">can result in errors</a>. For a nice overview of how to define them, <a href="https://eriqande.github.io/eca-bioinf-handbook/alignment-of-sequence-data-to-a-reference-genome-and-associated-steps.html#read-groups">see this example</a>.</p></div></div><p>Taken together, an example would be:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem <span class="dt">\</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">-t</span> 2 <span class="dt">\</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">-Y</span> <span class="at">-K</span> 100000000 <span class="dt">\</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">-R</span> <span class="st">"@RG\tID:L001\tPL:ILLUMINA\tSM:PF0080"</span> <span class="dt">\</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">-o</span> <span class="st">"PF0080.sam"</span> <span class="dt">\</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="va">${ref}</span><span class="st">"</span> <span class="dt">\</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="va">${fastq_dir}</span><span class="st">/PF0080_S44_L001_R1_001.fastq.gz"</span> <span class="dt">\</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"</span><span class="va">${fastq_dir}</span><span class="st">/PF0080_S44_L001_R2_001.fastq.gz"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Of course, there exist various other options that can be used to do things like tweak the parameters, scores and thresholds used for local alignment.</p>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise: mapping with <code>bwa mem</code>
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Map a single pair of reads to the reference genome (use the Peruvian <em>P. falciparum</em> AmpliSeq data).</li>
<li>Open the resulting SAM file using <code>less</code> and inspect its contents and structure.</li>
</ol>
</div>
</div>
<div id="tip-parallel" class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip&nbsp;14.4: Speeding up code through multi-threading or parallelization
</div>
</div>
<div class="callout-body-container callout-body">
<p>Some of the tasks that we are faced with as bioinformaticians can take a long time to complete, even when using modern hardware. Fortunately, some of these tasks can be parallelized. Which ones? Well, any task that consists of a specific procedure that needs to be applied to many files in the same manner, but for which the different processes are independent of one another. This is sometimes called <em>“embarrassingly parallel”</em> and can be achieved by simply running the different tasks as the same time on multiple threads or compute cores.</p>
<p>You could script this yourself using a tool like <code>parallel</code> (see <a href="https://speciationgenomics.github.io/mapping_reference/">here for an example</a>), and it’s also an important aspect of more advanced workflow managers like Nextflow, but fortunately many of the tools that we use also provide built-in multi-threading: <code>bwa mem</code>, <code>samtools</code>, <code>trimmomatic</code>, etc.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Host DNA contamination removal
</div>
</div>
<div class="callout-body-container callout-body">
<p>When analysing WGS data (but not AmpliSeq) it is important to remove human reads from your FASTQ files prior to mapping them to the <em>Plasmodium</em> reference genome. There are a number of different approaches and dedicated tools to this - assigning reads to different organisms is a crucial step in <a href="https://genomics.sschmeier.com/ngs-taxonomic-investigation/">bacterial metagenomics for example</a> - but one of the most common approaches for malaria genomics is to simply do a two-step mapping process with your alignment software of choice: in the first round all reads are mapped against the human reference genome. Anything that <em>“sticks”</em> is discarded. In the second round, the remaining unmapped reads are mapped to <em>Plasmodium</em>.</p>
<p>When depositing genetic data into public sequencing data repository like <a href="http://www.ncbi.nlm.nih.gov/sra">NCBI’s SRA</a> or <a href="http://www.ebi.ac.uk/ena/">EMBL-EBI’s ENA</a>, only filtered FASTQ files should be used, to avoid any potential issues with regards to human privacy and data protection.</p>
<p>You could try this for yourself as a bonus exercise. See <a href="https://linsalrob.github.io/ComputationalGenomicsManual/Deconseq/">this guide</a> for more info on how to filter out the host/non-host reads using <code>samtools</code> after the mapping step.</p>
</div>
</div>
</section>
<section id="sec-samtools" class="level2 page-columns page-full" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="sec-samtools"><span class="header-section-number">14.4</span> SAM and BAM files</h2>
<p>The output of the alignment step (using <code>bwa mem</code>) is a SAM file (see <a href="../unix/6-unix-more-commands.html#sec-sam-format" class="quarto-xref"><span>Section 6.2.1</span></a>). This stands for <em>Sequence Alignment Map</em>. These are plain text files delimited with tabs, so you can view them using a text editor or a command like <code>less</code>.</p>
<p>To save space and make the alignment quicker to index, SAM files are often converted to BAM files (<a href="../unix/6-unix-more-commands.html#sec-bam-format" class="quarto-xref"><span>Section 6.4.1</span></a>), which are compressed binary versions of the alignment. These can be used by downstream tools directly, so we tend to only store the alignment in this format, even though you can no longer inspect the alignment yourself.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>0080_S44_L001.bam | head -n30</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>@HD     VN:1.6  SO:coordinate</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_01_v3  LN:640851</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_02_v3  LN:947102</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_03_v3  LN:1067971</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_04_v3  LN:1200490</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_05_v3  LN:1343557</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_06_v3  LN:1418242</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_07_v3  LN:1445207</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_08_v3  LN:1472805</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_09_v3  LN:1541735</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_10_v3  LN:1687656</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_11_v3  LN:2038340</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_12_v3  LN:2271494</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_13_v3  LN:2925236</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_14_v3  LN:3291936</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_API_v3 LN:34250</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>@SQ     SN:Pf3D7_MIT_v3 LN:5967</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>@RG     ID:001  SM:001  PL:ILLUMINA</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>@PG     ID:bwa  PN:bwa  VN:0.7.17-r1188 CL:bwa mem ../reference/PlasmoDB-67_Pfalciparum3D7_Genome.fasta PF0080_S44_L001_R1_001.fastq.gz PF0080_S44_L001_R2_001.fastq.gz -t 4 -k 30 -R @RG\tID:001\tSM:001\tPL:ILLUMINA</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>@PG     ID:samtools     PN:samtools     PP:bwa  VN:1.19.2       CL:samtools sort -@ 4 -o ../../results/bwa/PF0080_S44_L001.bam</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>@PG     ID:samtools.1   PN:samtools     PP:samtools     VN:1.19.2       CL:samtools view -h training/results/bwa/PF0080_S44_L001.bam</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:2118:16821:2796     2211    Pf3D7_01_v3     35509   0       84H71M144H      =       193095  157838      AAAAAAAAAAAAAAAAAAAAAAAAAAAATTAAAAAAAAAAAAAAAAAAAAACATTAAAAAAAATAAAAAAA FFGFEGGGGGGGGGGGGGGGGGGGGGE33,@FGGBEGGGG**&gt;CE*B**=5*;++23C+9*7C0&lt;CD?+:*     NM:i:5  MD:Z:42T4T0T2A2A16      MC:Z:51H73M2D177M       AS:i:46 XS:i:45 RG:Z:001        SA:Z:Pf3D7_01_v3,193086,+,112M187S,60,1;Pf3D7_13_v3,2049877,-,41S32M226S,0,0;       XA:Z:Pf3D7_05_v3,+529511,87S43M6I19M144S,7;Pf3D7_13_v3,-112651,164S40M95S,0;Pf3D7_12_v3,+497450,90S35M3D19M155S,4;Pf3D7_12_v3,+100906,96S18M1D41M2I11M131S,6;Pf3D7_11_v3,-973273,152S11M1I10M2D34M91S,3;</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:2105:5392:16351     2211    Pf3D7_01_v3     35510   12      84H70M147H      =       193086  157856      AAAAAAAAAAAAAAAAAAAAAAAAAAATTAAAAAAAAAATAAAAAAAAAACATAAAAAAAAAAAAAAAAA  AFGGGGGGGGGGGGGGGGGGGGGGG&gt;:,,CFGGCFGGGG,,@DF9EC*&gt;**,,,6&lt;?,**:8/?EEE8=8      NM:i:6  MD:Z:39A1T4T0T2A11T7    MC:Z:80M4D3M1I193M      AS:i:40 XS:i:33 RG:Z:001        SA:Z:Pf3D7_01_v3,193086,+,111M190S,60,1;    XA:Z:Pf3D7_09_v3,-1458764,146S20M1I30M104S,3;</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:1114:12861:20875    2179    Pf3D7_01_v3     67176   0       70H30M199H      Pf3D7_07_v3     405766      0       TTTTTATTTAAAACACAAAAAAAAAAAAAA  ,38,,,,,,,,,8,,,&gt;*,,355C7&lt;@@7@  NM:i:0  MD:Z:30 MC:Z:146M155H   AS:i:30 XS:i:0      RG:Z:001        SA:Z:Pf3D7_07_v3,405968,-,242S13M1I43M,0,2;Pf3D7_12_v3,1133014,-,159S38M102S,0,1;</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:1119:27790:13377    145     Pf3D7_01_v3     109767  0       174S39M88S      Pf3D7_07_v3     405766      0       TGTCACACACGTAGTGTTGTGACAGTCGTATCAGTGTATTATTGTACGTCTGTTTGTTTATTATATTTTATTATTGTGTTTTTGTTATTATGTGTTGATGTGTTAACGGAGAGTGTAGAGTAAGAGGAAAGTATTTTAGTATTTTTAATATTTTTAATTTTAAAATTAAAAATTTATTTTTTTTTTTTTTTTTTTTTTTTTTTTTAAATAATTAATTTTTTTTTAAATTTGTTTTAAATTAAATTGGTTTTTTGTTTAAAAAAATTTTTATTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT   )-).(-(((((()4.()))6).(((4()444.)))46.)6))-((-((.((,.()))))))))6)6)--)))),((4,(((-.))-)..)((),)),)((-)(2.(((,)()))*-***)***9**/***01**2*0*+2***2*20+3*0++++++3++++0++2*+&lt;300+2+**CGEEGEDGGGGGGECGGEE&gt;GGE@,D3,,,,,3,,,,,*3++,,,,,3,,,,,,,,,,8,,@,,3A+3+CCD8AFC,AB=4+,FC,4,,9,:,:@@EGEGGFGGGGGGGGGGGGGGGGGCCCCC       NM:i:0  MD:Z:39 MC:Z:128M7I119M45S      AS:i:39 XS:i:38 RG:Z:001        SA:Z:Pf3D7_09_v3,683170,-,263S38M,0,0;  XA:Z:Pf3D7_05_v3,+166830,86S38M177S,0;Pf3D7_10_v3,+448221,90S38M173S,0;Pf3D7_01_v3,-519133,169S35M97S,0;Pf3D7_07_v3,-399258,171S35M95S,0;Pf3D7_14_v3,-2709009,170S35M96S,0;</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:2109:24931:7426     2145    Pf3D7_01_v3     134097  0       236H16M3I46M    Pf3D7_12_v3     2093554     0       AACAAAACAAAAAAAACATACAAATAAATACAAACAAAAAAAAAAAAAAAAAAAAAAACAAAAAA       .*)(,)0(77),&lt;012(4))*)*.).).)))))5((,.(-(-((27((4(-91-(70&gt;(4.334(   NM:i:7  MD:Z:17G3C3A31C4        MC:Z:25H276M    AS:i:33 XS:i:32 RG:Z:001        SA:Z:Pf3D7_01_v3,193086,+,111M190S,60,2;Pf3D7_06_v3,932942,-,146S29M2I29M95S,8,3;   XA:Z:Pf3D7_09_v3,+1284793,269S32M,0;Pf3D7_12_v3,-659692,4S30M267S,0;</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:2116:28002:9063     2211    Pf3D7_01_v3     134127  18      242H33M26H      =       193113  59239       ACAAAAAAAAAAAAAAAAAAAAAAACACAAAAA       .()).(4&gt;B9(((-7(39&gt;91-341(3(,,6(0       NM:i:0  MD:Z:33 MC:Z:27H53M4D3M1I193M       AS:i:33 XS:i:0  RG:Z:001        SA:Z:Pf3D7_01_v3,193086,+,110M191S,60,0;Pf3D7_12_v3,448676,-,138S27M1I22M3I24M86S,0,7;</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:1113:17834:11827    2161    Pf3D7_01_v3     137459  4       56H74M171H      =       196019  58732       TTATTGTTTTTTTTTTTATCGTTATTGTTTTTGTTATTATTATTATTGTTTTTGTTATTATTATTATTGTTTTT      9),&lt;:2&gt;EEB@&lt;?;+2(0))*;+*;A987GA=;7;+++31++*7F&lt;;**GGF?*:=,++,,+1=,&gt;5F?8EE@;  NM:i:4  MD:Z:11A2A4T0A53        MC:Z:56H245M    AS:i:54 XS:i:50 RG:Z:001        SA:Z:Pf3D7_08_v3,1374826,+,41M9D29M231S,6,9;        XA:Z:Pf3D7_01_v3,-137459,77S80M144S,6;Pf3D7_01_v3,+196068,123S99M79S,10;</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:1111:24375:10578    99      Pf3D7_01_v3     139572  0       84S32M185S      =       139572  32 CTTGAACCCAGGAGGTAGAGGTTGCAGTGAGCCGAGATCGCACCCCTGCACTCCAGCCTGGGGGACAGAGTGAGACTCTGTCTCAAAATAAATAAATAAATAAATAAACAAATAAAAGATAACTGTTTAATTAACAACAACGTAATAGATAGTGTGTGGCACTGATACCACCTGTAAAAATAAAATGAACAACGGTGTAAAGACCAAGAGGAGAGAAATGGAAGTGTCCTATTGTAAGCTTCTCTTACTCTACGAAAAATGGTATATTACTTAAGAATAAACTATGATAATTAAGACGGCA    CCCCCFGGGGGGGGGGGFGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGFGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGGCEGGGGGGGGGGGGGGGGGGGGCGGEGGGGGGGGGGDC3;DGGGGGGGGGGGG7FD9BFGGGFFFAA;&gt;FB@FEFFBBCFCEFF&gt;0&gt;B&gt;AEFEEF:5=B59FDAEFFFECEFFFCFF7&lt;64CC4=.75)7797&lt;)9CE))(-4-   NM:i:0  MD:Z:32     MC:Z:80S32M188S AS:i:32 XS:i:32 RG:Z:001        XA:Z:Pf3D7_06_v3,+225165,84S32M185S,0;</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>M05795:43:000000000-CFLMP:1:1111:24375:10578    147     Pf3D7_01_v3     139572  0       80S32M188S      =       139572  -32AACCCAGGAGGTAGGGGTTGCAGTGAGCCGAGATCGCACCCCTGCAGTCCAGCCGGGGGGACAGAGTGAGACTCTGTCTCAAAATAAATAAATAAATAAATAAACAAATAAAAGATAACTGTTTAATTAACAACAACGTAATAGATAGTGTGTGGCACTGATACCACCTGTAAAAATAAAATGAACAACGGTGTAAAGACCAAGAGGAGAGAAATGGAAGTGTCCTATTGTAAGCTTCTCTTACTCTAAGAAAAATGGTATATTACTTAAGAATAAACTATGATAATTAAGGCTGCATTT     4,(563?;3@2;:6(:4)E7.);)5(96-0(FD&gt;2==@:252&gt;7)85DA8=1):):DBEED&gt;8:*&gt;;;::D:53:5:)@7FEDEDDEFCDE9&gt;EEEC;7ED:099;9;+&gt;D=C?C?96B?D7D9EBGGGD8GGFFGGCGGGGGEF8@@,GGGGGGGGGDGFFC6GGGGGGGGFGGGEGGGGGGGGCEGGGGGGCGGGGGGGGGF:GGGGGGFCGGGDGFFDGFGFGGGGGGGGGFGGGFGGGFGGGGGGEGFE9GFGGGGGGGGFFFFGGGGGGGGGFFGGFE&lt;GFAGGGGGGGGCCCCC    NM:i:0  MD:Z:32     MC:Z:84S32M185S AS:i:32 XS:i:32 RG:Z:001        XA:Z:Pf3D7_06_v3,-225165,80S32M188S,0;</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Aside from the header info, every other line in the SAM file corresponds to a particular read and provides information on where in the reference genome it was mapped and the quality of this mapping<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>, alongside various other metadata (including the original Phred quality scores). This information is stored in tab-delimited fields (11 mandatory ones, followed by optional ones).</p>
<div class="no-row-height column-margin column-container"><div id="fn8"><p><sup>8</sup>&nbsp;Mapping quality is similar to the per-base quality scores we introduced in the previous chapter, but here they represent the probability of a wrong alignment of the entire read. More info <a href="http://www.acgt.me/blog/2014/12/16/understanding-mapq-scores-in-sam-files-does-37-42">here</a> and <a href="https://davetang.org/muse/2011/09/14/mapping-qualities/">here</a>.</p></div></div><table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">Col</th>
<th style="text-align: center;">Field</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Brief description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">QNAME</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">Query template NAME</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">FLAG</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">bitwise FLAG</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">RNAME</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">References sequence NAME</td>
</tr>
<tr class="even">
<td style="text-align: center;">4</td>
<td style="text-align: center;">POS</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">1- based leftmost mapping POSition</td>
</tr>
<tr class="odd">
<td style="text-align: center;">5</td>
<td style="text-align: center;">MAPQ</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">MAPping Quality</td>
</tr>
<tr class="even">
<td style="text-align: center;">6</td>
<td style="text-align: center;">CIGAR</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">CIGAR string</td>
</tr>
<tr class="odd">
<td style="text-align: center;">7</td>
<td style="text-align: center;">RNEXT</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">Ref. name of the mate/next read</td>
</tr>
<tr class="even">
<td style="text-align: center;">8</td>
<td style="text-align: center;">PNEXT</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">Position of the mate/next read</td>
</tr>
<tr class="odd">
<td style="text-align: center;">9</td>
<td style="text-align: center;">TLEN</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">observed Template LENgth</td>
</tr>
<tr class="even">
<td style="text-align: center;">10</td>
<td style="text-align: center;">SEQ</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">segment SEQuence</td>
</tr>
<tr class="odd">
<td style="text-align: center;">11</td>
<td style="text-align: center;">QUAL</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">ASCII of Phred-scaled base QUALity+33</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>All details on the SAM format can be found in the format specification: <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">https://samtools.github.io/hts-specs/SAMv1.pdf</a>.<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<p>One important column is the bitwise FLAG: it is a lookup code that can tell you (or more commonly, a software tool) whether a read was aligned, how it is oriented, if its pair was aligned, etc.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Bit</th>
<th style="text-align: right;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>0x1</td>
<td style="text-align: right;">template having multiple segments in sequencing</td>
</tr>
<tr class="even">
<td>2</td>
<td>0x2</td>
<td style="text-align: right;">each segment properly aligned according to the aligner</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0x4</td>
<td style="text-align: right;">segment unmapped</td>
</tr>
<tr class="even">
<td>8</td>
<td>0x8</td>
<td style="text-align: right;">next segment in the template unmapped</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0x10</td>
<td style="text-align: right;">SEQ being reverse complemented</td>
</tr>
<tr class="even">
<td>32</td>
<td>0x20</td>
<td style="text-align: right;">SEQ of the next segment in the template being reverse complemented</td>
</tr>
<tr class="odd">
<td>64</td>
<td>0x40</td>
<td style="text-align: right;">the first segment in the template</td>
</tr>
<tr class="even">
<td>128</td>
<td>0x80</td>
<td style="text-align: right;">the last segment in the template</td>
</tr>
<tr class="odd">
<td>256</td>
<td>0x100</td>
<td style="text-align: right;">secondary alignment</td>
</tr>
<tr class="even">
<td>512</td>
<td>0x200</td>
<td style="text-align: right;">not passing filters, such as platform/vendor quality controls</td>
</tr>
<tr class="odd">
<td>1024</td>
<td>0x400</td>
<td style="text-align: right;">PCR or optical duplicate</td>
</tr>
<tr class="even">
<td>2048</td>
<td>0x800</td>
<td style="text-align: right;">supplementary alignment</td>
</tr>
</tbody>
</table>
<p>Lastly, we want to share this <a href="https://broadinstitute.github.io/picard/explain-flags.html">convenient tool</a> to explain the different bitwise FLAGs. It is invaluable whenever you need to perform (or interpret) a <code>samtools</code> filtering operation.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn9"><p><sup>9</sup>&nbsp;A more in-depth exploration of the different type of alignments that can occur (e.g., supplementary, secondary, etc.) is given in <a href="https://cmdcolin.github.io/posts/2022-02-06-sv-sam">this blogpost</a>.</p></div><div id="fn10"><p><sup>10</sup>&nbsp;An amazing guide to several <code>samtools</code> tasks can be found on the <a href="https://davetang.github.io/learning_bam_file/">Learning the BAM format page by Dave Tang</a>.</p></div></div><p>To convert a SAM to a BAM file, you can use the <a href="http://www.htslib.org/doc/samtools.html">samtools software</a>. <code>samtools</code> is used to convert between SAM and BAM files, but it can perform many other tasks too, like coordinate sorting, which we will talk about first.<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a></p>
</section>
<section id="coordinate-sorting-alignment-files" class="level2 page-columns page-full" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="coordinate-sorting-alignment-files"><span class="header-section-number">14.5</span> Coordinate sorting alignment files</h2>
<p>The reads in a SAM/BAM file can be sorted in different ways. For our needs (variant calling using GATK), we will need to sort them according to their location on the reference genome: a <em>coordinate-ordered</em> format.</p>
<p>The neat thing is that <code>samtools sort</code> will automatically do the conversion from SAM to BAM for us, so we can perform both steps in one go.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> sort <span class="at">-@</span> <span class="op">&lt;</span>number_of_threads<span class="op">&gt;</span> -o <span class="op">&lt;</span>output.bam<span class="op">&gt;</span> <span class="op">&lt;</span>input.sam<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Can we make things even more streamlined and combine the <code>bwa</code> mapping and <code>samtools</code> sorting steps? Turns out we can!</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Chaining commands via pipes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Recall what you learned in <a href="../unix/7-unix-redirection.html#sec-unix-streams" class="quarto-xref"><span>Section 7.1</span></a> about piping the output of one command into the input of another using the <code>|</code> operator. We can make use of this to feed the output of <code>bwa mem</code> directly into <code>samtools</code>. This allows us to forego the need to write the output to any intermediate files.<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a></p>
<p>The only difference compared to before is that we now remove the <code>-o output.sam</code> option from the <code>bwa mem</code> command and that we do not provide an explicit input file to <code>samtools</code> (it is read from <code>stdout</code> directly instead).<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> mem <span class="op">&lt;</span>arguments<span class="op">&gt;</span> <span class="kw">|</span> <span class="ex">samtools</span> sort <span class="at">-o</span> alignment.sort.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For clarity we use the <code>sorted.bam</code> file suffix for any sorted BAM files.</p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn12"><p><sup>12</sup>&nbsp;One final thing we could do is use <code>&gt;</code> to write the output of <code>samtools</code> to a file directly, instead of using the <code>-o</code> flag.</p></div></div><div class="no-row-height column-margin column-container"><div id="fn11"><p><sup>11</sup>&nbsp;This works out of the box, but you might encounter the syntax <code>command_1 | command_2 -</code>, where the hyphen <code>-</code> is a way of explicitly telling the second command to look at <code>stdin</code> for its input. For many tools, including <code>samtools</code>, <a href="https://bioinformatics.stackexchange.com/questions/20773/problem-with-samtools-command-with-a-final-hyphen">this is not necessary however</a>.</p></div></div><div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Align the same FASTQ file as you did in the previous exercise, but immediately pipe the <code>bwa mem</code> output to <code>samtools</code> for coordinate sorting and conversion to a <code>.bam</code> file.</p></li>
<li><p>Compare the size of the original <code>.sam</code> and the new <code>.bam</code> file (<code>du -sh</code>).</p></li>
<li><p>Modify your mapping script to immediately perform compression and sorting using the <code>samtools sort</code> command, without producing any intermediate files.</p></li>
</ol>
</div>
</div>
</section>
<section id="sec-samtools-flagstat" class="level2" data-number="14.6">
<h2 data-number="14.6" class="anchored" data-anchor-id="sec-samtools-flagstat"><span class="header-section-number">14.6</span> Inspecting BAM files</h2>
<p>You can read BAM files by using the <code>samtools view</code> command. By default it only outputs the tab-delimited parts of the file, but you can provide the flags <code>-H or</code>-h` to optionally show only the header or everything.</p>
<p>Another useful command is <code>samtools flagstat</code>, which reports various mapping statistics on how well the reads aligned to your reference genome:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>samtools flagstat training/results/bwa/PF0097_S43_L001.bam</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>104559 + 0 in total (QC-passed reads + QC-failed reads)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>95962 + 0 primary</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>0 + 0 secondary</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>8597 + 0 supplementary</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>0 + 0 duplicates</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>0 + 0 primary duplicates</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>103657 + 0 mapped (99.14% : N/A)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>95060 + 0 primary mapped (99.06% : N/A)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>95962 + 0 paired in sequencing</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>47981 + 0 read1</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>47981 + 0 read2</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>89790 + 0 properly paired (93.57% : N/A)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>94736 + 0 with itself and mate mapped</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>324 + 0 singletons (0.34% : N/A)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>4246 + 0 with mate mapped to a different chr</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>3834 + 0 with mate mapped to a different chr (mapQ&gt;=5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercises
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Explore the output of the <code>samtools flagstat</code> command. What do the different statistics mean?</p></li>
<li><p>How can you store the mapping statistics in a file? What do you need to take into consideration when doing this in a for loop for multiple bam files?</p></li>
<li><p>Try to write a script for processing all FASTQ files belonging to the Peruvian <em>P. falciparum</em> AmpliSeq data in one go. You can inspect the provided scripts <a href="../../training/scripts/map.sh"><code>map.sh</code></a> and <a href="../../training/scripts/map-extended.sh"><code>map-extended.sh</code></a> for inspiration, especially with regards to file paths and structuring your code.</p></li>
</ol>
<p><strong>Bonus exercise:</strong> do the same for the Vietnam <em>P. vivax</em> WGS data.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Upping your scripting game
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you’re just starting out, it is fine to use simple scripts using just the concepts that you know. As you become more experienced though, and as your scripts might need to be used by others and re-use it for a longer time, you should try to focus on making them more <em>readable</em>, <em>robust</em> and <em>efficient</em>. For the former, focus on doing things in a clear and structured way; use code comments, clear file names, split your scripts into logical chunks when necessary, provide READMEs, etc. Writing robust and efficient scripts is more like a never-ending journey, where you can pick up new techniques and ideas even after a lot of experience, and it might extend beyond the use of just bash, but into other languages or even workflow managers. You can compare the normal and the extended versions of the scripts in <code>./training/scripts</code> for some ideas.</p>
<p>For now, knowing enough to get by, and <strong>being careful</strong> when trying things out, is most important. Howvever, if you decide in the future that really want to master bash, there are also several <a href="https://bertvv.github.io/cheat-sheets/Bash.html">resources</a> availabe that <a href="https://mywiki.wooledge.org/BashPitfalls">explain</a> some of the more common <a href="https://flokoe.github.io/bash-hackers-wiki/scripting/newbie_traps/">beginner mistakes</a>. Alternatively, you can look into <a href="https://ricomnl.com/blog/bottom-up-bioinformatics-pipeline/">workflow tools</a> like <a href="https://www.nextflow.io/">Nextflow</a> (and the <a href="https://nf-co.re/">nf-core community pipelines</a>), <a href="https://snakemake.github.io/">Snakemake</a> or <a href="http://byronjsmith.com/make-bml/">Makefiles</a>.</p>
</div>
</div>
<section id="sec-samtools-index" class="level3" data-number="14.6.1">
<h3 data-number="14.6.1" class="anchored" data-anchor-id="sec-samtools-index"><span class="header-section-number">14.6.1</span> More indices</h3>
<p>Like our reference FASTA files, BAM files can also be indexed to improve the performance of downstream tools that need to search for particular reads in this large file. For example, it is required for visualisation with IGV (<a href="#sec-alignment-visualisation" class="quarto-xref"><span>Section 14.9</span></a>) and variant calling with GATK (<a href="variant-calling.html" class="quarto-xref"><span>Chapter 15</span></a>).</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> index alignment.sort.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise
</div>
</div>
<div class="callout-body-container callout-body">
<p>Try to create an index for one of your BAM files. Which new files are created?</p>
</div>
</div>
</section>
</section>
<section id="sec-picard-duplicates" class="level2 page-columns page-full" data-number="14.7">
<h2 data-number="14.7" class="anchored" data-anchor-id="sec-picard-duplicates"><span class="header-section-number">14.7</span> Mark PCR duplicates - <code>picard MarkDuplicates</code></h2>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
PCR duplicates tagging/removal should <strong>NOT</strong> be performed for AmpliSeq data
</div>
</div>
<div class="callout-body-container callout-body">
<p>The library construction process for AmpliSeq results in identical fragments or duplicates for each of the targeted amplicons, hence we should not attempt to remove them.<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a></p>
</div>
</div>
<div class="no-row-height column-margin column-container"><div id="fn13"><p><sup>13</sup>&nbsp;As a side note, in RNA-seq this duplicate removal step is also not recommended (unless unique molecular identifiers (UMIs) are used), although the number of duplicates can be used for quality control.</p></div><div id="fn14"><p><sup>14</sup>&nbsp;You can read more about how PCR duplicates arise in this excellent <a href="https://www.cureffi.org/2012/12/11/how-pcr-duplicates-arise-in-next-generation-sequencing/">blog post</a> by Eric Minikel.</p></div></div><p>A final step in the mapping pipeline is the tagging (or removal) of PCR duplicates. These are identical sequences that can arise because of PCR steps during library preparation or because a cluster on the flow cell was erroneously detected as two separate ones<a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup>14</sup></a>. The overall goal of PCR duplicate removal is to reduce bias during downstream analyses (like variant detection) due to their presence.</p>
<p>PCR duplicates are polyclonal molecules that do not represent any true biological variation, nor are they independent observations of the DNA that was present in a sample. Thus, the observed abundance of these identical reads does not accurately reflect the true abundance of the different molecules in the sample<span class="citation" data-cites="rochette_causes_2023">(<a href="../references.html#ref-rochette_causes_2023" role="doc-biblioref">Rochette et al. 2023</a>)</span>. If a particular PCR duplicate happens to be over-represented compared to other reads covering the same region of the genome, this could cause a bias in our analyses. <a href="https://bioinformatics.stackexchange.com/a/2868">Just imagine what would happen</a> if during PCR amplification an error was introduced into one of the fragments. If we ended up with many PCR duplicates of this fragment, we might erroneously conclude that there is a SNP at this position because we see it occur in multiple reads. However, if we remove PCR duplicates, we will only observe the SNP in a single read, and variant detection will not mark this as a SNP due to lack of confidence (~agreement between different reads covering the same position, more on that in <a href="variant-calling.html" class="quarto-xref"><span>Chapter 15</span></a>).</p>
<p>One of the tools that we use for marking PCR duplicates is <a href="https://broadinstitute.github.io/picard/">Picard</a>. Picard actually provides many different functionalities, but the one that we’re interested for now is <code>MarkDuplicates</code>. An in-depth explanation of how it works can be found <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360057439771-MarkDuplicates-Picard">here</a>. After running the tool, we end up with a BAM file again, but this time with all suspected PCR duplicates marked as such. Our downstream analysis tools will take this information into account whenever relevant (e.g., when detecting variants).<a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup>15</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn15"><p><sup>15</sup>&nbsp;Note that removal generally is not necessary, but it can be done by passing the <code>-REMOVE_DUPLICATES true</code> flag.</p></div></div><div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercises
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Try to mark all PCR duplicates for a single BAM file using the following command:</li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">picard</span> MarkDuplicates</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-I</span> alignment.sort.bam</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-O</span> alignment.sort.dups.bam</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-M</span> alignment.markeddups_metrics.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ol start="2" type="1">
<li><p>Run <code>samtools flagstat</code> again. What changed compared to the previous report?</p></li>
<li><p>Examine and run the <a href="../../training/scripts/remove_dups.sh"><code>remove_dups.sh</code></a> script to process all files.</p></li>
</ol>
<p><strong>Bonus exercise:</strong> Try to combine all the steps of the pipeline we have seen so far (including trimming) into a single script.</p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Remember to use meaningful file names
</div>
</div>
<div class="callout-body-container callout-body">
<p>You might have noticed in the example above that we continued to extend the suffix of the BAM file to indicate what has happened to it: sorting and PCR duplicate marking. This information is also kept track of in the BAM header, but it is a good habit to still look for appropriate file names whenever possible.</p>
</div>
</div>
<hr>
<div id="warning-bqsr" class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>The pipeline that we’re introducing here deviates from the GATK4 best practices in this section, because we do not introduce the concept of <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360035890531-Base-Quality-Score-Recalibration-BQSR">base quality score recalibration (BQSR)</a>. The basic idea here is that we want to detect and correct systematic errors made by the sequencer, by using our knowledge of known variants to model them.</p>
<p>The above link by GATK gives an in-depth explanation on the topic, but you can also find some interesting discussions <a href="https://bioinformatics.stackexchange.com/questions/321/is-there-a-point-in-recalibration-of-scores-for-variant-calling">here</a>, <a href="https://www.biostars.org/p/280274/">here</a> and <a href="https://www.biostars.org/p/399004/">here</a> as well as some <a href="https://learn.gencore.bio.nyu.edu/variant-calling/pre-processing/">hands-on walkthroughs here (section 6)</a> and <a href="https://www.melbournebioinformatics.org.au/tutorials/tutorials/variant_calling_gatk1/variant_calling_gatk1/#3-base-quality-recalibration">here</a>.</p>
</div>
</div>
</section>
<section id="sec-picard-metrics" class="level2" data-number="14.8">
<h2 data-number="14.8" class="anchored" data-anchor-id="sec-picard-metrics"><span class="header-section-number">14.8</span> Alignment statistics</h2>
<p>We already introduced the <code>samtools flagstat</code> command to report on basic alignment statistics, but a more in-depth method of inspecting your alignment is provided by <a href="https://gatk.broadinstitute.org/hc/en-us/articles/21904987074587-CollectAlignmentSummaryMetrics-Picard">Picard’s <code>CollectAlignmentSummaryMetrics</code></a>, or <a href="https://gatk.broadinstitute.org/hc/en-us/articles/360037594031-CollectMultipleMetrics-Picard">the more extensive <code>CollectMultipleMetrics</code></a> (we will see Picard again in the next section on PCR duplicate removal):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">picard</span> CollectAlignmentSummaryMetrics R=<span class="op">&lt;</span>reference.fasta<span class="op">&gt;</span> I=<span class="op">&lt;</span>input.sort.bam<span class="op">&gt;</span> O=<span class="op">&lt;</span>output.bam<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The output of these tools can again be aggregated using a tool like MulitQC. See <a href="https://www.melbournebioinformatics.org.au/tutorials/tutorials/variant_calling_gatk1/files/multiqc_report.html">here</a> for an example.</p>
</section>
<section id="sec-alignment-visualisation" class="level2" data-number="14.9">
<h2 data-number="14.9" class="anchored" data-anchor-id="sec-alignment-visualisation"><span class="header-section-number">14.9</span> Alignment visualisation</h2>
<p>After creating and filtering our alignment files, we can visualise them in a tool like <a href="https://igv.org/">IGV (Integrative Genomics Viewer)</a>. We refer to <a href="https://training.galaxyproject.org/training-material/topics/sequence-analysis/tutorials/mapping/tutorial.html#visualization-using-a-genome-browser-igv">this section</a> of the Galaxy training materials <span class="citation" data-cites="Hiltemann_2023 sequence-analysis-mapping">(<a href="../references.html#ref-Hiltemann_2023" role="doc-biblioref">Hiltemann et al. 2023</a>; <a href="../references.html#ref-sequence-analysis-mapping" role="doc-biblioref">Wolff, Batut, and Rasche</a>)</span>.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-ClevaLab_2022_blog" class="csl-entry" role="listitem">
ClevaLab. 2022. <span>“A Step-by-Step Guide to NGS.”</span> <a href="https://www.clevalab.com/post/a-step-by-step-guide-to-ngs">https://www.clevalab.com/post/a-step-by-step-guide-to-ngs</a>.
</div>
<div id="ref-Hiltemann_2023" class="csl-entry" role="listitem">
Hiltemann, Saskia, Helena Rasche, Simon Gladman, Hans-Rudolf Hotz, Delphine Larivière, Daniel Blankenberg, Pratik D. Jagtap, et al. 2023. <span>“Galaxy Training: A Powerful Framework for Teaching!”</span> Edited by Francis Ouellette. <em><span>PLoS Comput Biol</span> Computational Biology</em> 19 (1): e1010752. <a href="https://doi.org/10.1371/journal.pcbi.1010752">https://doi.org/10.1371/journal.pcbi.1010752</a>.
</div>
<div id="ref-malariagen_pf7_2023" class="csl-entry" role="listitem">
MalariaGEN, Muzamil Mahdi Abdel Hamid, Mohamed Hassan Abdelraheem, Desmond Omane Acheampong, Ambroise Ahouidi, Mozam Ali, Jacob Almagro-Garcia, et al. 2023. <span>“Pf7: An Open Dataset of Plasmodium Falciparum Genome Variation in 20,000 Worldwide Samples.”</span> <em>Wellcome Open Research</em> 8 (January): 22. <a href="https://doi.org/10.12688/wellcomeopenres.18681.1">https://doi.org/10.12688/wellcomeopenres.18681.1</a>.
</div>
<div id="ref-rochette_causes_2023" class="csl-entry" role="listitem">
Rochette, Nicolas C., Angel G. Rivera‐Colón, Jessica Walsh, Thomas J. Sanger, Shane C. Campbell‐Staton, and Julian M. Catchen. 2023. <span>“On the Causes, Consequences, and Avoidance of <span>&lt;</span>Span Style="font-Variant:small-Caps;"<span>&gt;</span><span>PCR</span><span>&lt;</span>/Span<span>&gt;</span> Duplicates: Towards a Theory of Library Complexity.”</span> <em>Molecular Ecology Resources</em> 23 (6): 1299–1318. <a href="https://doi.org/10.1111/1755-0998.13800">https://doi.org/10.1111/1755-0998.13800</a>.
</div>
<div id="ref-sequence-analysis-mapping" class="csl-entry" role="listitem">
Wolff, Joachim, Bérénice Batut, and Helena Rasche. <span>“Mapping (Galaxy Training Materials).”</span> <a href="https://training.galaxyproject.org/training-material/topics/sequence-analysis/tutorials/mapping/tutorial.html">https://training.galaxyproject.org/training-material/topics/sequence-analysis/tutorials/mapping/tutorial.html</a>.
</div>
</div>
</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../content/genomics/qc.html" class="pagination-link" aria-label="Quality control and trimming">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Quality control and trimming</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../content/genomics/variant-calling.html" class="pagination-link" aria-label="Variant calling">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Variant calling</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Unless otherwise noted, all content on this site is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>. <a href="https://creativecommons.org/licenses/by/4.0/"><img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="CC" height="30"></a> <a href="https://creativecommons.org/licenses/by/4.0/"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="BY" height="30"></a> <br> © <a href="https://pmoris.github.io">Pieter Moris</a> - <a href="https://research.itg.be/en/organisations/malariology">ITM Malariology</a>, 2024.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>
<script>var lightboxQuarto = GLightbox({"openEffect":"zoom","descPosition":"bottom","closeEffect":"zoom","selector":".lightbox","loop":false});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>